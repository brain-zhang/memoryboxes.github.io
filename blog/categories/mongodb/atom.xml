<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Mongodb | memoryboxes blog]]></title>
  <link href="http://memoryboxes.github.io/blog/categories/mongodb/atom.xml" rel="self"/>
  <link href="http://memoryboxes.github.io/"/>
  <updated>2015-07-12T07:02:21+00:00</updated>
  <id>http://memoryboxes.github.io/</id>
  <author>
    <name><![CDATA[memoryboxes]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Different Users in Same Unix Group Can Not Run Mongod]]></title>
    <link href="http://memoryboxes.github.io/blog/2015/04/10/different-users-in-same-unix-group-can-not-run-mongod/"/>
    <updated>2015-04-10T00:44:42+00:00</updated>
    <id>http://memoryboxes.github.io/blog/2015/04/10/different-users-in-same-unix-group-can-not-run-mongod</id>
    <content type="html"><![CDATA[<p>事情的缘起是这样的&hellip;&hellip;.</p>

<p>想要在Dockerfile中启动一个MongoDB，之后编译为Docker image。(不要问我问什么要在docker image中存一个mongodb数据库，真实世界的需求你永远想不到)</p>

<p>Docker build不支持 &mdash;privileged，所以默认的/etc/init.d/mongod  这个脚本中的</p>

<p><code>
runuser -s /bin/bash mongod -c 'ulimit -S -c 0 &gt;/dev/null 2&gt;&amp;1 ; numactl --interleave=all /usr/bin/mongod -f /etc/mongod.conf'
</code></p>

<p>这种写法就死翘翘了。</p>

<p>github上有这个Issue:</p>

<p><a href="https://github.com/docker/docker/issues/1916">https://github.com/docker/docker/issues/1916</a></p>

<p>大家讨论了1年多，对于怎么解决，还是没有个所以然。(话说要再吐槽一下github的issue了，一般大一点的项目，一个issue跨度以年来论，长篇大论读完也不容易呀)</p>

<p>最后只好在Dockerfile中这么搞:</p>

<p>```</p>

<pre><code>mongod --fork -f /etc/mongod.conf &amp;&amp; \
mongod --shutdown -f /etc/mongod.conf &amp;&amp; \
chown mongod:mongod /opt/lib/mongodbpath -R
</code></pre>

<p>```</p>

<p>这样build就顺利完成了。</p>

<p>可是启动这个image为container后，执行:</p>

<p><code>
/etc/init.d/mongod start
</code></p>

<p>报错:</p>

<p><code>
 [initandlisten] warning couldn't write to / rename file /datadir/journal/prealloc.0: couldn't open file /datadir/journal/prealloc.0 for writing errno:1 Operation not permitted
</code></p>

<p>虾米，明明已经加了mongod的group了。而且errorno是1，不是 <code>"errno:13 Permission denied"</code>，有点奇怪。</p>

<p>问题在这里:</p>

<p><a href="https://jira.mongodb.org/browse/SERVER-7583">https://jira.mongodb.org/browse/SERVER-7583</a></p>

<p>要再加一个指令:</p>

<p><code>
setcap cap_fowner+ep /usr/bin/mongod
</code></p>

<p>就是这么折腾。</p>
]]></content>
  </entry>
  
</feed>
